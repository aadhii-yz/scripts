#!/bin/env bash

set -eo pipefail

CONFIG_DIR="$HOME/.config/jrnl"
CONFIG_FILE="$CONFIG_DIR/jrnl.conf"
JRNL_EDITOR="${VISUAL:-${EDITOR:-vi}}"
ROOT_DIR=""
REMOTE_REPO=""
BRANCH="master"
NOTE_FILE=""

main () {
  if [[ ! -t 1 ]]; then
    echo "This program expects you to run this script directly."
    exit 1
  fi
  
  load_config
  init_root_dir

  case "$1" in
    "cd")
      cd "$ROOT_DIR" || exit
      exec "${SHELL:-/bin/bash}" -i
    ;;

    "read"|"")
      if is_there glow > /dev/null; then
        glow "$ROOT_DIR"
        exit 0
      else
        echo "glow does not exist in path"
        echo "Visit: https://github.com/charmbracelet/glow?tab=readme-ov-file#installation"
        "$JRNL_EDITOR" "$ROOT_DIR"
        exit 0
      fi
    ;;

    "daily")
      YYYY="$(date +"%Y")"
      MM="$(date +"%m")"
      DD_DAY="$(date +"%d_%a")"

      DIR="Daily/$YYYY/$MM"
      if [[ ! -d "$ROOT_DIR/$DIR" ]]; then
        mkdir -p "$ROOT_DIR/$DIR"
      fi

      NOTE_FILE="$DIR/$DD_DAY.md"
      "$JRNL_EDITOR" "$NOTE_FILE"
    ;;

    "note")
      DIR="Notes"

      NAME=""
      if [[ -z "$2" ]]; then
        if is_there gum > /dev/null; then
          NAME=$(gum input --prompt="Enter Note FileName : " --placeholder="draft")
        else
          echo "gum does not exit in PATH"
          echo "Visit: https://github.com/charmbracelet/gum?tab=readme-ov-file#installation"
          printf "Enter Note FileName : "
          read -r NAME
        fi
      fi

      if [[ -z "$NAME" ]]; then
        echo "Error reading filename"
        exit 1
      fi

      if [[ ! -d "$ROOT_DIR/$DIR" ]]; then
        mkdir -p "$ROOT_DIR/$DIR"
      fi

      NOTE_FILE="$DIR/$NAME.md"
      "$JRNL_EDITOR" "$ROOT_DIR/$NOTE_FILE"
    ;;

    "sync")
      if ! is_there git > /dev/null; then
        echo "git not found; can't clone remote repo; using local repo"
        exit 1
      fi

      # Pull changes
      git -C "$ROOT_DIR" pull --rebase --autostash origin "$BRANCH" || {
        echo "Rebase failed. Aborting and trying merge..."
        git -C "$ROOT_DIR" rebase --abort
        git -C "$ROOT_DIR" pull --no-rebase origin "$BRANCH" || {
          echo "Merge also failed. Please resolve conflicts manually."
          exit 1
        }
      }

      # Commit changes
      git -C "$ROOT_DIR" add -A
      git -C "$ROOT_DIR" commit -m "Auto-sync: $(date '+%Y-%m-%d %H:%M:%S')" || true

      # Push
      git -C "$ROOT_DIR" push origin "$BRANCH"
    ;;

    "pull")
      if ! is_there git > /dev/null; then
        echo "git not found; can't clone remote repo; using local repo"
        exit 1
      fi

      # Pull changes
      git -C "$ROOT_DIR" pull --rebase --autostash origin "$BRANCH" || {
        echo "Rebase failed. Aborting and trying merge..."
        git -C "$ROOT_DIR" rebase --abort
        git -C "$ROOT_DIR" pull --no-rebase origin "$BRANCH" || {
          echo "Merge also failed. Please resolve conflicts manually."
          exit 1
        }
      }
    ;;

    "fzf")
      if ! is_there fzf; then
        echo "fzf not found in path"
        echo "Visit: https://junegunn.github.io/fzf/installation/"
        exit 1
      fi

      "$JRNL_EDITOR" "$(fzf -m --walker-root="$ROOT_DIR")"
    ;;

    "help"|"-h"|"--help") usage "$@" ;;
    *) usage; exit 1 ;;
  esac
}

usage() {
  cat << EOF
Usage: ${0##*/} [command] [args]

Commands:
  cd        cd into $ROOT_DIR
  read      open your files with glow or $JRNL_EDITOR
  daily     create and open an entry for today
  note      create and opens a note entry (optional arg for note name)
  sync      pull & push your changes
  pull      just pull the changes
  fzf       fuzzy find your files for editing
  help      prints this help
EOF
}

load_config() {
  if [[ ! -e "$CONFIG_FILE" ]]; then
    [[ ! -d "$CONFIG_DIR" ]] && mkdir "$CONFIG_DIR"
    cat << EOF > "$CONFIG_FILE"
local_dir = # $HOME/journal
remote_repo = # https://github.com/user-name/journal
# branch = main # default: branch = master
# fill the above config for your environment
EOF
    "$JRNL_EDITOR" "$CONFIG_FILE"
    exit
  fi

  while IFS='= ' read -r key value; do
    # Skip comments
    if [[ $key =~ ^#.* ]] || [[ -z $key ]]; then
      continue
    fi

    case $key in
      "local_dir") ROOT_DIR=$(eval echo "$value");;
      "remote_repo") REMOTE_REPO=$value;;
      "branch") BRANCH=$value;;
      *) continue;; # Skip other values
    esac
  done < "$CONFIG_FILE"

  if [[ -z $ROOT_DIR ]] || [[ -z $REMOTE_REPO ]]; then
    echo "Invalid config"
    exit 1
  fi
}

init_root_dir() {
  if [[ ! -d "$ROOT_DIR" ]]; then
    if ! is_there git > /dev/null; then
      echo "git not found; can't clone remote repo; using local repo"
      mkdir -p "$ROOT_DIR"
      return
    fi
    mkdir -p "$ROOT_DIR"
    git clone --depth=1 "$REMOTE_REPO" "$ROOT_DIR"
  fi
}

is_there() {
  command -v "$1" >/dev/null 2>&1
}

main "$@"
